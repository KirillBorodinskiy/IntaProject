{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create your board</title>
    <link rel="stylesheet" type="text/css" href="{% static 'application/styles.css' %}">
</head>
<body>
    <div class="container">
        <div class="currentShip">
            <div id="Ships">
                {% for ship in ShipList%}
                    <div class="ship ship{{ship}}"></div>

                    <input type="radio" class="Ship{{ship}}Select" name="shipLength" value="ship{{ship}}">
                    <label for="vertical">Ship {{ship}}</label>
                {% endfor %}
            </div>
            <div>
                <input type="radio" id="vertical" name="options" value="vertical">
                <label for="vertical">Vertical</label>
            </div>
            <div>
                <input type="radio" id="horizontal" name="options" value="horizontal" checked>
                <label for="horizontal">Horizontal</label>
            </div>
        </div>
        <div class="grid grid1">
            {% for row_index, row in board.items %} 
                {% for col_index, cell in row.items %}
                    <div id ="grid{{row_index}}{{col_index}}" data-hidden-value="0" class="block block1" data-row="{{ row_index }}" data-col="{{ col_index }}" 
                         onclick="updateHiddenFieldsAndSubmit({{ row_index }}, {{ col_index }})"
                         {% if cell %} occupied {% endif %}>
                        {% if cell %} {{ cell }} {% endif %} 
                    </div>
                {% endfor %}
            {% endfor %}
        </div>

        <button id="SendButton" onclick="SendIT()">SEND IT</button>
        <script>
            function SendIT(row, column){
                const data = {
                    row: row,
                    column: column
                };
        
                // Send the data to the server using Fetch API
                fetch('/add-ship-position/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')  // Ensure CSRF protection for POST requests
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        alert('Ship position added successfully! Position ID: ' + result.id);
                    } else {
                        alert('Failed to add ship position: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }

            SendIT(5, 4);
            
            function updateHiddenFieldsAndSubmit(row, col) {
                var gridId = "grid" + row + col;
                var orientationVertical = document.getElementById("vertical").checked;

                for(let ShipLength=1;ShipLength<5;ShipLength++){

                    var currentShip = "Ship"+ShipLength+"Select";

                    var currentShipElements = document.getElementsByClassName(currentShip);
                    let isChecked = false;
                    for (const element of currentShipElements) {
                    if (element.checked) {
                        isChecked = true;
                        break;
                    }
                    }
                    if(isChecked){
                        if(document.getElementById(gridId).dataset.hiddenValue == 1){
                            
                            for(let i=0;i<ShipLength;i++){
                                if(orientationVertical==true){
                                    var gridId = "grid" + (row+i) + col;
                                }else{
                                    var gridId = "grid" + row + (col+i);
                                }
                                document.getElementById(gridId).dataset.hiddenValue = 0;
                                document.getElementById(gridId).style.backgroundColor = "rgb(173, 216, 230)";
                            }
                            for (const element of document.getElementsByClassName("ship"+ShipLength)) {
                                if (element.style.backgroundColor!="rgb(0, 86, 179)") {
                                    element.style.backgroundColor="rgb(0, 86, 179)";
                                    break;
                                }
                            }
                        }else{

                            for(let i=0;i<ShipLength;i++){
                                if(orientationVertical==true){
                                    var gridId = "grid" + (row+i) + col;
                                }else{
                                    var gridId = "grid" + row + (col+i);
                                }
                                document.getElementById(gridId).dataset.hiddenValue = 1;
                                document.getElementById(gridId).style.backgroundColor = "rgb(76, 175, 80)";
                            }
                            for (const element of document.getElementsByClassName("ship"+ShipLength)) {
                                if (element.style.backgroundColor!="rgb(76, 175, 80)") {
                                    element.style.backgroundColor="rgb(76, 175, 80)";
                                    break;
                                }
                            }
                        }
                    }       
                }         
            }
            
        </script>
    </body>
</html>