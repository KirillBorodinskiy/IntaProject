{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Create your board</title>
    <link rel="stylesheet" type="text/css" href="{% static 'application/styles.css' %}">
</head>
<body>
    <div class="container">
        <div class="currentShip">
            <div id="Ships">
                {% for ship in ShipList%}
                    <div class="ship ship{{ship}}"></div>

                    <input type="radio" class="Ship{{ship}}Select" name="shipLength" value="ship{{ship}}">
                    <label for="vertical">Ship {{ship}}</label>
                {% endfor %}
            </div>
            <div>
                <input type="radio" id="vertical" name="options" value="vertical">
                <label for="vertical">Vertical</label>
            </div>
            <div>
                <input type="radio" id="horizontal" name="options" value="horizontal" checked>
                <label for="horizontal">Horizontal</label>
            </div>
        </div>
        <div class="grid grid1">
            {% for row_index, row in board.items %} 
                {% for col_index, cell in row.items %}
                    <div id ="grid{{row_index}}{{col_index}}" data-hidden-value="0" class="block block1" data-row="{{ row_index }}" data-col="{{ col_index }}" 
                         onclick="updateHiddenFieldsAndSubmit({{ row_index }}, {{ col_index }})"
                         {% if cell %} occupied {% endif %}>
                        {% if cell %} {{ cell }} {% endif %} 
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
        <button type="submit" onclick="getBoard()">Send it!</button>

        <script>
            function updateGameCell(gameId, row, col, value) {
                // Create the data object to send
                const data = {
                    game_id: gameId,
                    row: row,
                    col: col,
                    value: value
                };
            
                // Get the CSRF token (if needed)
                const csrftoken = getCookie('csrftoken');
            
                // Send a POST request to the Django backend
                fetch('/update-cell/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken // Only if CSRF protection is enabled
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        console.log('Cell updated successfully');
                    } else {
                        console.error('Error updating cell:', result.message);
                    }
                })
                .catch(error => {
                    console.error('Request failed:', error);
                });
            }
            function getBoard(){
                const board = [];

                for (let row_index = 0; row_index < 10; row_index++) {
                  const row = [];
                  for (let col_index = 0; col_index < 10; col_index++) {
                    row.push(document.getElementById("grid"+row_index+col_index).dataset.hiddenValue); 
                  }
                  board.push(row);
                }
                return board;
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            function updateHiddenFieldsAndSubmit(row, col) {
                const gridId = "grid" + row + col;
                const orientationVertical = document.getElementById("vertical").checked;
            
                // Find the first checked ship
                let selectedShipLength = null;
                for (let ShipLength = 1; ShipLength < 5; ShipLength++) {
                    const currentShip = "Ship" + ShipLength + "Select";
                    const isChecked = Array.from(document.getElementsByClassName(currentShip)).some(element => element.checked);
            
                    if (isChecked) {
                        selectedShipLength = ShipLength;
                        break;
                    }
                }
            
                if (selectedShipLength) {
                    // Check for the maximum number of ships placed
                    let counterOfTheSameShipLengthPlaced = 0;
                    for (const element of document.getElementsByClassName("ship" + selectedShipLength)) {
                        if (element.style.backgroundColor == "rgb(76, 175, 80)") {
                            counterOfTheSameShipLengthPlaced++;
                        }
                    }
                    if (counterOfTheSameShipLengthPlaced == (5 - selectedShipLength)) {
                        // Uncheck the currently selected radio button
                        const currentShipRadios = document.getElementsByClassName("Ship"+selectedShipLength+"Select");
                        for (const radio of currentShipRadios) {
                            if (radio.checked) {
                                radio.checked = false;
                                break; // No need to continue checking once we uncheck one
                            }
                        }
                    
                        // Check the radio button for the next smaller ship length (if available)
                        if (selectedShipLength > 1) {
                            const nextShipRadios = document.getElementsByClassName("Ship"+(selectedShipLength-1)+"Select");
                            nextShipRadios[0].checked = true; // Check the first radio button in the group
                        }
                        return; 
                    }
            
                    // Check for adjacent occupied cells
                    let canPlaceShip = true;
                    for (let i = 0; i < selectedShipLength; i++) {
                        const currentRow = orientationVertical ? row + i : row;
                        const currentCol = orientationVertical ? col : col + i;
            
                        // Check current cell and adjacent cells
                        for (let r = currentRow - 1; r <= currentRow + 1; r++) {
                            for (let c = currentCol - 1; c <= currentCol + 1; c++) {
                                if (r >= 0 && r < 10 && c >= 0 && c < 10) { // Check if within bounds
                                    const adjacentGridId = "grid" + r + c;
                                    if (document.getElementById(adjacentGridId).dataset.hiddenValue == 1) {
                                        canPlaceShip = false;
                                        break; 
                                    }
                                }
                            }
                            if (!canPlaceShip) break; 
                        }
                        if (!canPlaceShip) break;
                    }
            
                    if (canPlaceShip) {
                        const newColor = "rgb(76, 175, 80)";
            
                        for (let i = 0; i < selectedShipLength; i++) {
                            //If vertical => grid+(row+i)+col
                            const currentGridId = orientationVertical ? "grid" + (row + i) + col : "grid" + row + (col + i);
            
                            document.getElementById(currentGridId).dataset.hiddenValue = 1;
                            document.getElementById(currentGridId).style.backgroundColor = newColor;
                            
                        }
            
                        // Find the first ship element that's not already colored
                        const shipElements = document.getElementsByClassName("ship" + selectedShipLength);
                        for (const element of shipElements) {
                            if (element.style.backgroundColor != newColor) {
                                element.style.backgroundColor = newColor;
                                break;
                            }
                        }

                    } else {
                        // Handle the case where the ship can't be placed (e.g., show an alert)
                        alert("Cannot place ship here. There are adjacent ships!");
                    }
                } 
            }
            
            
        </script>
    </body>
</html>