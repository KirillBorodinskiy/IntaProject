{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Application</title>
    <link rel="stylesheet" type="text/css" href="{% static "application/styles.css" %}">
    
</head>
<body>
    <div class="game-boards container">
        <div>
            <h3></h3>
        </div>
    {% for player, board in boards.items %}
        <div class="game-board">
            <h2 style="{% if user.username|lower == player|lower %} color:rgb(0, 123, 255) {% else %} color:rgb(255 30 0)  {% endif %}">
                {{ player|capfirst }}'s Board
            </h2>

            {% if current_turn|lower == player|lower %}
                <p style="color: green;">It's {{ player|capfirst }}'s turn</p>
            {% else %}
                <p style="color: gray;">Waiting for {{ player|capfirst }}'s turn</p>
            {% endif %}

            <div class="board-grid">
                <div class="block cell"></div>  {# Empty corner cell #}
                {% for letter in rl|slice:"1:" %}
                    <div class="block cell label">{{ letter.1 }}</div> 
                {% endfor %}

                {% for row_index, row in board.items %} 
                    <div class="block cell label">{{ row_index|add:1 }}</div> {## Row label placed first ##}
                    {% for col_index, cell in row.items %} 
                        <div id="grid{{row_index}}{{col_index}}" data-hidden-value="{{cell}}" 
                            class="block block1 
                            {% if user.username|lower == player|lower %} 
                                {% if cell == '1' %} occupied
                                {% elif cell == '2' %} hit
                                {% elif cell == '3' %} missed {% endif %}
                            {% else %}
                            {% if cell == '2' %} hit
                            {% elif cell == '3' %} missed {% endif %}
                                block_enemy cursor
                            {% endif %}" 
                            data-row="{{ row_index }}" data-col="{{ col_index }}"
                            {% if user.username != player %}
                                onclick="shoot({{ row_index }},{{ col_index }})" 
                            {% endif %}>
                            
                        </div>
                    {% endfor %}
                {% endfor %} 
            </div>
        </div>
    {% endfor %}

    </div>
</body>
<script>
    function shoot(row,col){
    
        // Create the data object to send
        const data = {
            row: row,
            col: col,
            game_id: {{game_id}},
        };
        // Get the CSRF token
        const csrftoken ='{{csrf_token}}';
    
        // Send a POST request to the Django backend
        fetch('/update-board/', {  // Adjust the URL if your view has a different name or path
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // Include the CSRF token if you have CSRF protection enabled
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Handle the successful shot (e.g., update the board display, check for game over)
                console.log('Shot successful:', result);
                // You'll likely need to update the opponent's board display based on the 'result' data
            } else {
                // Handle errors (e.g., display an error message)
                console.error('Error shooting:', result.message);
            }
            location.reload();
        })
        .catch(error => {
            console.error('Request failed:', error);
        });

    }
    function pollForUpdates() {
        const csrftoken ='{{csrf_token}}';
        const gameId = '{{game_id}}'; // Get the gameId from your template context
        fetch(`/check_for_updates/${gameId}/`,{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken // Include the CSRF token if you have CSRF protection enabled
            }
        })
            .then(response => response.json())
            .then(result => {
                if (result.update) {
                    location.reload(); // Reload the page if there's an update
                }
            })
            .catch(error => {
                console.error('Polling failed:', error);
            });
    }
    
    // Poll every 5 seconds (adjust the interval as needed)
    setInterval(pollForUpdates, 5000); 
</script>
</html>
